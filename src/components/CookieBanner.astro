---
const consentKey = "cookie-consent";
---

<div id="cc-banner" class="fixed m-5 bottom-0 z-[100]">
  <div
    class="mx-auto max-w-2xl m-4 rounded-2xl border border-gray-800 bg-black/50 text-gray-100 backdrop-blur px-6 py-5 shadow-2xl"
  >
    <div class="flex gap-4 flex-col items-center">
      <div class="space-y-1">
        <h3 class="text-lg font-semibold">Cookies &amp; Daten</h3>
        <p class="text-sm text-gray-300">
          Wir verwenden nur notwendige Cookies. Mit „Alle akzeptieren“ aktivierst du zusätzlich Analytics &amp; Marketing.
        </p>
      </div>

      <div class="flex flex-wrap gap-3">
        <button
          id="cc-necessary"
          class="rounded-xl border border-gray-700 px-4 py-2 text-sm hover:bg-neutral-800"
        >
          Nur notwendige
        </button>
        <button
          id="cc-accept"
          class="rounded-xl bg-white/10 px-4 py-2 text-sm font-medium hover:bg-white/20"
        >
          Alle akzeptieren
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  const KEY = "cookie-consent";

  const defaults = {
    essential: true,
    analytics: false,
    marketing: false,
    ts: null,
  };

  function getStored() {
    try {
      const raw = localStorage.getItem(KEY);
      if (!raw) return null;
      return JSON.parse(raw);
    } catch {
      return null;
    }
  }

  function save(consent) {
    const data = { ...consent, ts: new Date().toISOString() };
    localStorage.setItem(KEY, JSON.stringify(data));

    // Expose & event
    window.__consent = {
      get: () => JSON.parse(localStorage.getItem(KEY) || "null"),
      set: (c) => {
        save(c);
        applyScripts(c);
        document.dispatchEvent(new CustomEvent("cookie-consent:change", { detail: c }));
      },
    };
    document.dispatchEvent(new CustomEvent("cookie-consent:change", { detail: data }));
  }

  function applyScripts(consent) {
    const nodes = document.querySelectorAll('script[type="text/plain"][data-category]');
    nodes.forEach((node) => {
      const cat = node.getAttribute("data-category");
      if (cat === "essential" || consent?.[cat]) {
        const s = document.createElement("script");
        [...node.attributes].forEach((a) => {
          if (a.name === "type") return;
          if (a.name === "data-src") { s.src = a.value; return; }
          if (a.name.startsWith("data-")) return; // skip other data-*
          s.setAttribute(a.name, a.value);
        });
        if (node.textContent?.trim()) s.text = node.textContent;
        node.replaceWith(s);
      }
    });
  }

  // UI
  const banner = document.getElementById("cc-banner");
  const btnAccept = document.getElementById("cc-accept");
  const btnNecessary = document.getElementById("cc-necessary");

  // Initial: show/hide banner
  const existing = getStored();
  if (existing) {
    banner.style.display = "none";
    applyScripts(existing);
  } else {
    banner.style.display = "block";
  }

  // Buttons
  btnAccept?.addEventListener("click", () => {
    const consent = { essential: true, analytics: true, marketing: true };
    save(consent);
    applyScripts(consent);
    banner.style.display = "none";
  });

  btnNecessary?.addEventListener("click", () => {
    const consent = { ...defaults, analytics: false, marketing: false };
    save(consent);
    // Keine optionalen Skripte laden
    banner.style.display = "none";
  });

  // Expose API early
  window.__consent = {
    get: () => getStored(),
    set: (c) => {
      save(c);
      applyScripts(c);
    },
  };
</script>
